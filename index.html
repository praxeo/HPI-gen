<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HPI Generator â€” ED</title>
<style>
  :root{
    --bg:#0b0f14; --fg:#e7eef7; --muted:#a6b1be; --card:#121720; --accent:#8ab4ff; --danger:#ff6b6b; --ok:#76d275; --line:#1b2330;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:8px 14px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;position:sticky;top:0;background:linear-gradient(#0b0f14, #0b0f14ee)}
  h1{font-size:16px;margin:0 8px 0 0;color:var(--muted);font-weight:600}
  .pill{background:var(--card);border:1px solid var(--line);padding:6px 8px;border-radius:999px;display:flex;align-items:center;gap:6px}
  .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .seg button{background:transparent;color:var(--fg);padding:6px 10px;border:0;border-right:1px solid var(--line);cursor:pointer}
  .seg button:last-child{border-right:0}
  .seg button.active{background:var(--accent);color:#041225}
  input,textarea,select{background:#0f1520;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:8px}
  input[type="number"]{width:7ch}
  .hidden{display:none}
  main{display:grid;grid-template-columns:260px 1fr 420px;gap:12px;padding:12px}
  aside,.panel,.preview{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;min-height:70vh}
  .sec-title{font-weight:700;margin:8px 0 6px 0;color:#cbd6e2}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#0f1520;border:1px solid var(--line);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;cursor:pointer}
  .chip.active{outline:2px solid var(--accent);box-shadow:0 0 0 2px #0000,inset 0 0 0 999px rgba(138,180,255,.15)}
  .chip.danger{border-color:#3a2330;color:#ffb2b2}
  .stack{display:flex;flex-direction:column;gap:10px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
  hr{border:0;border-top:1px solid var(--line);margin:10px 0}
  .muted{color:var(--muted)}
  .kicker{color:#bcd; font-weight:600; letter-spacing:.02em}
  .preview{position:sticky; top:64px; display:flex; flex-direction:column}
  .preview textarea{flex:1;resize:vertical;min-height:320px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .right{margin-left:auto}
  .btn{background:#111827;border:1px solid var(--line);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#041225;border-color:#508ffb}
  .btn.ghost{background:transparent}
  .badge{border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted)}
  .warn{color:var(--danger)}
  .ok{color:var(--ok)}
  details summary{cursor:pointer;color:var(--muted)}
  .breadcrumb{display:flex;flex-wrap:wrap;gap:6px}
  .crumb{padding:4px 8px;border:1px dashed var(--line);border-radius:8px;color:var(--muted)}
  .crumb.done{border-style:solid;color:#bfe}
</style>
</head>
<body>

<header>
  <h1>HPI Generator</h1>
  <div class="pill">
    <span class="kicker">Age</span>
    <input id="age" type="number" min="0" max="120" placeholder="Age">
  </div>
  <div class="pill">
    <span class="kicker">Sex</span>
    <div class="seg" id="sexSeg">
      <button data-sex="female">F</button>
      <button data-sex="male">M</button>
      <button data-sex="other">Other</button>
      <button data-sex="unknown">Unknown</button>
    </div>
    <input id="sexOther" class="hidden" type="text" placeholder="Specify otherâ€¦" style="width:16ch">
  </div>
  <div class="pill hidden" id="pregPill">
    <span class="kicker">Pregnancy</span>
    <div class="seg" id="pregSeg">
      <button data-preg="yes">Yes</button>
      <button data-preg="no">No</button>
      <button data-preg="unknown">Unknown</button>
    </div>
  </div>
  <div class="right pill">
    <details>
      <summary>History source / limitations</summary>
      <div class="row" style="margin-top:6px">
        <label class="chip"><input type="checkbox" data-hist="patient"> patient</label>
        <label class="chip"><input type="checkbox" data-hist="family"> family</label>
        <label class="chip"><input type="checkbox" data-hist="ems"> EMS</label>
        <label class="chip"><input type="checkbox" data-hist="chart"> chart review</label>
        <label class="chip"><input type="checkbox" data-hist="unresponsive"> unresponsive</label>
        <label class="chip"><input type="checkbox" data-hist="ams"> altered mental status</label>
        <label class="chip"><input type="checkbox" data-hist="language"> language barrier</label>
      </div>
    </details>
  </div>
</header>

<main>
  <!-- Left: complaint + progress -->
  <aside>
    <div class="stack">
      <label class="sec-title">Chief complaint</label>
      <select id="complaintSelect"></select>
      <div id="pedsBadge" class="badge hidden">Pediatric mode</div>
      <hr>
      <div class="sec-title">Progress</div>
      <div id="breadcrumb" class="breadcrumb"></div>
      <div class="muted" style="margin-top:8px">Red flags are suggested, not required.</div>
    </div>
  </aside>

  <!-- Center: dynamic questions -->
  <section class="panel">
    <div id="dyn"></div>
  </section>

  <!-- Right: preview -->
  <section class="preview">
    <div class="row">
      <div class="sec-title" style="margin:0">Live HPI preview</div>
      <button id="copyBtn" class="btn primary right">Copy</button>
    </div>
    <textarea id="preview"></textarea>
    <div class="row">
      <button id="resetBtn" class="btn ghost">Reset</button>
      <span id="rfHint" class="muted right">ðŸ’¡ Mark red flags if present.</span>
    </div>
  </section>
</main>

<script>
/** =======================
 *  CONFIG (complaints)
 *  Add/edit here â€” no code changes needed for most tweaks.
 *  ======================= */
const COMPLAINTS = [
  {
    id:"chest_pain",
    label:"Chest pain (adult)",
    audience:"adult",
    redFlags:[
      {id:"cp_syncope", label:"syncope / near-syncope"},
      {id:"cp_rest_pain", label:"pain at rest with diaphoresis"},
      {id:"cp_neuro", label:"neuro deficits"},
      {id:"cp_hemoptysis", label:"hemoptysis"},
      {id:"cp_cocaine", label:"recent cocaine"},
      {id:"cp_anticoag", label:"on anticoagulation"}
    ],
    questions:[
      {id:"onset", label:"Onset", type:"choice", options:["sudden","gradual","unclear"]},
      {id:"duration", label:"Duration", type:"text", placeholder:"e.g., 30 minutes"},
      {id:"timing", label:"Timing", type:"choice", options:["constant","intermittent","waxing/waning"]},
      {id:"quality", label:"Quality", type:"choice", options:["pressure","tightness","sharp","burning","tearing"]},
      {id:"severity", label:"Severity (0â€“10)", type:"scale", min:0, max:10, step:1},
      {id:"location", label:"Location", type:"chips", options:["central","left chest","right chest","diffuse"]},
      {id:"radiation", label:"Radiation", type:"chips", options:["none","left arm","jaw","back"]},
      {id:"assoc", label:"Associated", type:"multichips", options:["dyspnea","diaphoresis","nausea/vomiting","palpitations","near-syncope"]},
      {id:"risk", label:"Risk factors", type:"multichips", options:["known CAD","estrogen therapy","immobilization","active cancer","recent surgery","prior PE/DVT","cocaine use"]},
      {id:"mods", label:"Modifiers", type:"multichips", options:["worse exertion","worse inspiration","better rest","worse lying flat","better leaning forward"]},
      {id:"context", label:"Context / notes", type:"textarea"}
    ]
  },
  {
    id:"headache",
    label:"Headache (adult)",
    audience:"adult",
    redFlags:[
      {id:"ha_thunder", label:"thunderclap / maximal at onset"},
      {id:"ha_exertional", label:"exertional / Valsalva triggered"},
      {id:"ha_neuro", label:"focal neuro deficits"},
      {id:"ha_meningeal", label:"fever/neck stiffness"},
      {id:"ha_preg", label:"pregnancy/postpartum"},
      {id:"ha_cancer", label:"known cancer / HIV"},
      {id:"ha_anticoag", label:"on anticoagulation"}
    ],
    questions:[
      {id:"onset", label:"Onset", type:"choice", options:["sudden","gradual","unclear"]},
      {id:"duration", label:"Duration", type:"text", placeholder:"e.g., 6 hours"},
      {id:"timing", label:"Timing", type:"choice", options:["constant","intermittent","recurrent"]},
      {id:"quality", label:"Quality", type:"choice", options:["throbbing","pressure","sharp","bandlike"]},
      {id:"severity", label:"Severity (0â€“10)", type:"scale", min:0, max:10, step:1},
      {id:"location", label:"Location", type:"chips", options:["diffuse","frontal","temporal","occipital","unilateral"]},
      {id:"assoc", label:"Associated", type:"multichips", options:["photophobia","phonophobia","nausea/vomiting","visual aura","neck pain"]},
      {id:"mods", label:"Modifiers", type:"multichips", options:["worse with activity","relieved by rest","no relief with OTC meds"]},
      {id:"context", label:"Context / notes", type:"textarea"}
    ]
  },
  {
    id:"abdominal_pain",
    label:"Abdominal pain (adult)",
    audience:"adult",
    redFlags:[
      {id:"abd_guard", label:"peritoneal signs / guarding"},
      {id:"abd_hypotension", label:"hypotension / syncope"},
      {id:"abd_gi_bleed", label:"GI bleeding"},
      {id:"abd_preg", label:"pregnancy (consider ectopic)"},
      {id:"abd_immune", label:"immunocompromised"},
    ],
    questions:[
      {id:"onset", label:"Onset", type:"choice", options:["sudden","gradual","unclear"]},
      {id:"duration", label:"Duration", type:"text", placeholder:"e.g., 12 hours"},
      {id:"location", label:"Location", type:"chips", options:["RUQ","RLQ","LUQ","LLQ","periumbilical","epigastric","diffuse"]},
      {id:"character", label:"Character", type:"choice", options:["cramping","aching","sharp","burning","colicky"]},
      {id:"assoc", label:"Associated", type:"multichips", options:["nausea/vomiting","diarrhea","constipation","fever","urinary symptoms","vaginal bleeding/discharge"]},
      {id:"mods", label:"Modifiers", type:"multichips", options:["worse after meals","improved with bowel movement","worse with movement"]},
      {id:"context", label:"Context / notes", type:"textarea"}
    ]
  },
  {
    id:"dyspnea",
    label:"Shortness of breath (adult)",
    audience:"adult",
    redFlags:[
      {id:"sob_hypoxia", label:"hypoxia / cyanosis"},
      {id:"sob_stridor", label:"stridor / airway compromise"},
      {id:"sob_chestpain", label:"concurrent chest pain"},
      {id:"sob_hemoptysis", label:"hemoptysis"},
      {id:"sob_unilateral_swelling", label:"unilateral leg swelling"},
      {id:"sob_anticoag", label:"on anticoagulation"}
    ],
    questions:[
      {id:"onset", label:"Onset", type:"choice", options:["sudden","gradual","unclear"]},
      {id:"duration", label:"Duration", type:"text", placeholder:"e.g., 2 days"},
      {id:"timing", label:"Timing", type:"choice", options:["continuous","episodic","exertional"]},
      {id:"triggers", label:"Triggers", type:"multichips", options:["exertion","lying flat","exposure","infection","allergens"]},
      {id:"assoc", label:"Associated", type:"multichips", options:["wheezing","cough","fever","pleuritic pain","leg swelling"]},
      {id:"risk", label:"Risk factors", type:"multichips", options:["known COPD/asthma","heart failure","prior PE/DVT","recent surgery/immobilization","active cancer"]},
      {id:"context", label:"Context / notes", type:"textarea"}
    ]
  },
  {
    id:"peds_fever_vom",
    label:"Fever / vomiting (peds)",
    audience:"peds",
    redFlags:[
      {id:"p_nuchal", label:"neck stiffness / meningismus"},
      {id:"p_lethargy", label:"toxic appearance / lethargy"},
      {id:"p_dehydration", label:"poor UOP / dry mucosa"},
      {id:"p_respiratory", label:"respiratory distress"},
      {id:"p_rash", label:"petechial/purpuric rash"}
    ],
    questions:[
      {id:"duration", label:"Duration of symptoms", type:"text", placeholder:"e.g., 24 hours"},
      {id:"fever", label:"Max temp (Â°F)", type:"text", placeholder:"e.g., 102.4"},
      {id:"intake", label:"PO intake", type:"choice", options:["normal","reduced","minimal"]},
      {id:"uop", label:"Urine output", type:"choice", options:["normal","reduced","none in 8â€“12h"]},
      {id:"assoc", label:"Associated", type:"multichips", options:["cough","congestion","diarrhea","abdominal pain","rash","ear pain"]},
      {id:"vax", label:"Vaccination status", type:"choice", options:["up to date","delayed","unknown"]},
      {id:"appearance", label:"Appearance", type:"choice", options:["nontoxic","ill-appearing","lethargic"]},
      {id:"sickcontacts", label:"Sick contacts", type:"choice", options:["none known","school/daycare","household"]},
      {id:"weight_source", label:"Weight source", type:"choice", options:["measured today","reported by caregiver"]},
      {id:"context", label:"Context / notes", type:"textarea"}
    ]
  }
];

/** =======================
 *  STATE
 *  ======================= */
const state = {
  age:null, sex:null, sexOther:null, pregnancy:null,
  history: new Set(),
  complaintId: COMPLAINTS[0].id,
  answers: {},   // answers[questionId] = value
  redflags: new Set()
};

/** =======================
 *  DOM refs
 *  ======================= */
const ageEl = document.getElementById('age');
const sexSeg = document.getElementById('sexSeg');
const sexOtherEl = document.getElementById('sexOther');
const pregPill = document.getElementById('pregPill');
const pregSeg = document.getElementById('pregSeg');
const complaintSelect = document.getElementById('complaintSelect');
const dyn = document.getElementById('dyn');
const previewEl = document.getElementById('preview');
const copyBtn = document.getElementById('copyBtn');
const resetBtn = document.getElementById('resetBtn');
const pedsBadge = document.getElementById('pedsBadge');
const breadcrumb = document.getElementById('breadcrumb');

/** =======================
 *  INIT
 *  ======================= */
COMPLAINTS.forEach(c=>{
  const opt = document.createElement('option');
  opt.value = c.id; opt.textContent = c.label;
  complaintSelect.appendChild(opt);
});
complaintSelect.value = state.complaintId;

renderComplaint();
renderPreview();

/** =======================
 *  HANDLERS
 *  ======================= */
ageEl.addEventListener('input', ()=>{
  const v = +ageEl.value;
  state.age = Number.isFinite(v) ? v : null;
  updatePregVisibility();
  updatePedsBadge();
  renderComplaint(); // peds complaint visibility may change messaging
  renderPreview();
});

sexSeg.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    sexSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.sex = btn.dataset.sex;
    sexOtherEl.classList.toggle('hidden', state.sex!=='other');
    if(state.sex!=='other') state.sexOther=null;
    updatePregVisibility();
    renderPreview();
  });
});

sexOtherEl.addEventListener('input', ()=>{
  state.sexOther = sexOtherEl.value.trim() || null;
  renderPreview();
});

pregSeg.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    pregSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.pregnancy = btn.dataset.preg;
    renderPreview();
  });
});

document.querySelectorAll('[data-hist]').forEach(ch=>{
  ch.addEventListener('change', ()=>{
    const key = ch.getAttribute('data-hist');
    if(ch.checked) state.history.add(key); else state.history.delete(key);
    renderPreview();
  });
});

complaintSelect.addEventListener('change', ()=>{
  state.complaintId = complaintSelect.value;
  state.answers = {};
  state.redflags = new Set();
  renderComplaint();
  renderPreview();
});

copyBtn.addEventListener('click', async ()=>{
  await navigator.clipboard.writeText(previewEl.value);
  copyBtn.textContent = "Copied âœ“";
  setTimeout(()=>copyBtn.textContent="Copy", 1200);
});

resetBtn.addEventListener('click', ()=>{
  state.answers = {};
  state.redflags = new Set();
  renderComplaint();
  renderPreview();
});

/** =======================
 *  RENDERERS
 *  ======================= */
function updatePregVisibility(){
  const show = (state.sex==='female' && Number.isFinite(state.age) && state.age>=12 && state.age<=50);
  pregPill.classList.toggle('hidden', !show);
  if(!show){
    state.pregnancy = null;
    pregSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  }
}

function updatePedsBadge(){
  const peds = Number.isFinite(state.age) && state.age < 18;
  pedsBadge.classList.toggle('hidden', !peds);
}

function currentComplaint(){
  const pedsMode = Number.isFinite(state.age) && state.age<18;
  // If user picked an adult complaint while age <18, it's still allowed.
  // We keep it simple: selection wins. Peds badge only affects wording.
  return COMPLAINTS.find(c=>c.id===state.complaintId);
}

function renderComplaint(){
  const comp = currentComplaint();
  dyn.innerHTML = '';
  breadcrumb.innerHTML = '';

  // Red flags
  const rfWrap = document.createElement('div');
  rfWrap.innerHTML = `<div class="sec-title">Red flags</div>`;
  const rfGrid = document.createElement('div'); rfGrid.className = 'grid';
  comp.redFlags.forEach(rf=>{
    const chip = document.createElement('div');
    chip.className = 'chip danger';
    chip.textContent = rf.label;
    chip.addEventListener('click', ()=>{
      toggleSet(state.redflags, rf.id);
      chip.classList.toggle('active', state.redflags.has(rf.id));
      renderPreview();
      updateBreadcrumb(comp);
    });
    rfGrid.appendChild(chip);
  });
  rfWrap.appendChild(rfGrid);
  dyn.appendChild(rfWrap);
  dyn.appendChild(document.createElement('hr'));

  // Questions
  comp.questions.forEach(q=>{
    const sec = document.createElement('div'); sec.className = 'stack';
    const lab = document.createElement('label'); lab.className='sec-title'; lab.textContent = q.label;
    sec.appendChild(lab);

    if(q.type==='choice'){
      const seg = document.createElement('div'); seg.className='seg';
      q.options.forEach(opt=>{
        const b=document.createElement('button'); b.textContent=opt;
        if(state.answers[q.id]===opt) b.classList.add('active');
        b.addEventListener('click', ()=>{
          seg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          state.answers[q.id]=opt;
          renderPreview();
          updateBreadcrumb(comp);
        });
        seg.appendChild(b);
      });
      sec.appendChild(seg);
    }

    if(q.type==='chips' || q.type==='multichips'){
      const grid=document.createElement('div'); grid.className='grid';
      const multi = q.type==='multichips';
      const cur = ensureSetAnswer(q.id);
      q.options.forEach(opt=>{
        const chip=document.createElement('div'); chip.className='chip';
        chip.textContent=opt;
        if(cur.has(opt)) chip.classList.add('active');
        chip.addEventListener('click', ()=>{
          if(multi){
            toggleSet(cur,opt);
          }else{
            cur.clear(); cur.add(opt);
          }
          state.answers[q.id]=cur;
          chip.classList.toggle('active');
          if(!multi){
            // deactivate siblings
            grid.querySelectorAll('.chip').forEach(c=>{
              if(c!==chip) c.classList.remove('active');
            });
          }
          renderPreview();
          updateBreadcrumb(comp);
        });
        grid.appendChild(chip);
      });
      sec.appendChild(grid);
    }

    if(q.type==='scale'){
      const row=document.createElement('div'); row.className='row';
      const input=document.createElement('input'); input.type='range';
      input.min=q.min; input.max=q.max; input.step=q.step||1;
      input.value = (typeof state.answers[q.id]==='number') ? state.answers[q.id] : Math.round((+q.max + +q.min)/2);
      const out=document.createElement('div'); out.className='badge'; out.textContent=input.value;
      input.addEventListener('input', ()=>{ state.answers[q.id]=+input.value; out.textContent=input.value; renderPreview(); updateBreadcrumb(comp); });
      row.appendChild(input); row.appendChild(out); sec.appendChild(row);
    }

    if(q.type==='text'){
      const inp=document.createElement('input'); inp.type='text'; inp.placeholder=q.placeholder||'';
      if(typeof state.answers[q.id]==='string') inp.value=state.answers[q.id];
      inp.addEventListener('input', ()=>{ state.answers[q.id]=inp.value.trim(); renderPreview(); updateBreadcrumb(comp); });
      sec.appendChild(inp);
    }

    if(q.type==='textarea'){
      const ta=document.createElement('textarea'); ta.rows=3; ta.placeholder=q.placeholder||'';
      if(typeof state.answers[q.id]==='string') ta.value=state.answers[q.id];
      ta.addEventListener('input', ()=>{ state.answers[q.id]=ta.value.trim(); renderPreview(); updateBreadcrumb(comp); });
      sec.appendChild(ta);
    }

    dyn.appendChild(sec);
  });

  updateBreadcrumb(comp);
}

function updateBreadcrumb(comp){
  const crumbs = [];
  // red flag crumb
  crumbs.push({label:'Red flags', done: state.redflags.size>0});
  comp.questions.forEach(q=>{
    const v = state.answers[q.id];
    let done=false;
    if(['text','textarea'].includes(q.type)) done = typeof v==='string' && v.length>0;
    if(['choice'].includes(q.type)) done = typeof v==='string';
    if(['chips','multichips'].includes(q.type)) done = v instanceof Set && v.size>0;
    if(['scale'].includes(q.type)) done = typeof v==='number';
    crumbs.push({label:q.label, done});
  });
  breadcrumb.innerHTML='';
  crumbs.forEach(c=>{
    const el=document.createElement('div'); el.className='crumb'+(c.done?' done':''); el.textContent=c.label;
    breadcrumb.appendChild(el);
  });
}

function renderPreview(){
  const comp = currentComplaint();
  const parts = [];

  // First line: age + sex + CC
  const ageStr = Number.isFinite(state.age) ? `${state.age}-year-old` : null;
  const sexStr = (()=>{
    if(state.sex==='female') return 'female';
    if(state.sex==='male') return 'male';
    if(state.sex==='other' && state.sexOther) return state.sexOther;
    return null;
  })();

  let subject = ageStr && sexStr ? `${ageStr} ${sexStr}` :
                ageStr ? ageStr :
                sexStr ? sexStr : 'Patient';

  // Pediatric subject tweak
  const peds = Number.isFinite(state.age) && state.age<18;
  if(peds) subject = `${ageStr ?? 'Child'}`;

  // Pregnancy tag (inline, no parentheses/extra PTA verbiage)
  const pregTag = (state.sex==='female' && state.pregnancy==='yes') ? 'pregnant ' : '';

  const ccPhrase = comp ? comp.label.replace(/\s*\((adult|peds)\)$/i,'').toLowerCase() : 'chief complaint';
  parts.push(`${subject} ${pregTag}presents with ${ccPhrase}.`);

  // Optional history source/limits
  if(state.history.size){
    const src = [];
    if(state.history.has('patient')) src.push('patient');
    if(state.history.has('family')) src.push('family');
    if(state.history.has('ems')) src.push('EMS');
    if(state.history.has('chart')) src.push('chart review');
    const srcStr = src.length ? `History provided by ${src.join(', ')}` : '';
    const lim = [];
    if(state.history.has('unresponsive')) lim.push('unresponsive');
    if(state.history.has('ams')) lim.push('altered mental status');
    if(state.history.has('language')) lim.push('language barrier');
    const limStr = lim.length ? `limited by ${lim.join(', ')}` : '';
    const join = [srcStr, limStr].filter(Boolean).join('; ');
    if(join) parts.push(`${capitalize(join)}.`);
  }

  // Complaint-specific assembly
  parts.push(buildComplaintSentences(comp, state));

  // Red flags sentence (if any checked)
  if(state.redflags.size){
    const labels = comp.redFlags.filter(r=>state.redflags.has(r.id)).map(r=>r.label);
    if(labels.length) parts.push(`Red flags reported: ${listify(labels)}.`);
  }

  // Output
  previewEl.value = tidy(parts.filter(Boolean).join(' '));
}

/** Build sentences for each complaint from answers */
function buildComplaintSentences(comp, st){
  if(!comp) return '';

  const a = (id)=>st.answers[id];
  const s = [];

  if(comp.id==='chest_pain'){
    // onset/duration/quality/severity/location/radiation/assoc/risk/mods
    const bits = [];
    if(a('onset')) bits.push(`${a('onset')} onset`);
    if(a('duration')) bits.push(`${a('duration')} duration`);
    if(a('timing')) bits.push(a('timing'));
    if(a('quality')) bits.push(a('quality'));
    if(typeof a('severity')==='number') bits.push(`severity ${a('severity')}/10`);
    if(setHas(a('location'))) bits.push(`located ${fromSet(a('location'))}`);
    if(setHas(a('radiation')) && !a('radiation').has('none')) bits.push(`radiating to ${fromSet(a('radiation'))}`);
    if(bits.length) s.push(capitalize(bits.join(', ')) + '.');

    if(setHas(a('assoc'))) s.push(`Associated symptoms: ${fromSet(a('assoc'))}.`);
    if(setHas(a('risk'))) s.push(`Risk factors: ${fromSet(a('risk'))}.`);
    if(setHas(a('mods'))) s.push(`Modifiers: ${fromSet(a('mods'))}.`);
    if(a('context')) s.push(a('context') + '.');
  }

  if(comp.id==='headache'){
    const bits = [];
    if(a('onset')) bits.push(`${a('onset')} onset`);
    if(a('duration')) bits.push(`${a('duration')} duration`);
    if(a('timing')) bits.push(a('timing'));
    if(a('quality')) bits.push(a('quality'));
    if(typeof a('severity')==='number') bits.push(`severity ${a('severity')}/10`);
    if(setHas(a('location'))) bits.push(`${fromSet(a('location'))} location`);
    if(bits.length) s.push(capitalize(bits.join(', ')) + '.');

    if(setHas(a('assoc'))) s.push(`Associated symptoms: ${fromSet(a('assoc'))}.`);
    if(setHas(a('mods'))) s.push(`Modifiers: ${fromSet(a('mods'))}.`);
    if(a('context')) s.push(a('context') + '.');
  }

  if(comp.id==='abdominal_pain'){
    const bits = [];
    if(a('onset')) bits.push(`${a('onset')} onset`);
    if(a('duration')) bits.push(`${a('duration')} duration`);
    if(setHas(a('location'))) bits.push(`${fromSet(a('location'))}`);
    if(a('character')) bits.push(a('character'));
    if(bits.length) s.push(capitalize(bits.join(', ')) + '.');

    // Pregnancy mention is already inline near the start when positive
    if(setHas(a('assoc'))) s.push(`Associated symptoms: ${fromSet(a('assoc'))}.`);
    if(setHas(a('mods'))) s.push(`Modifiers: ${fromSet(a('mods'))}.`);
    if(a('context')) s.push(a('context') + '.');
  }

  if(comp.id==='dyspnea'){
    const bits = [];
    if(a('onset')) bits.push(`${a('onset')} onset`);
    if(a('duration')) bits.push(`${a('duration')} duration`);
    if(a('timing')) bits.push(a('timing'));
    if(bits.length) s.push(capitalize(bits.join(', ')) + '.');

    if(setHas(a('triggers'))) s.push(`Triggers: ${fromSet(a('triggers'))}.`);
    if(setHas(a('assoc'))) s.push(`Associated: ${fromSet(a('assoc'))}.`);
    if(setHas(a('risk'))) s.push(`Risk factors: ${fromSet(a('risk'))}.`);
    if(a('context')) s.push(a('context') + '.');
  }

  if(comp.id==='peds_fever_vom'){
    const bits = [];
    if(a('duration')) bits.push(`duration ${a('duration')}`);
    if(a('fever')) bits.push(`fever max ${a('fever')} Â°F`);
    if(bits.length) s.push(capitalize(bits.join(', ')) + '.');

    const statusBits = [];
    if(a('intake')) statusBits.push(`PO intake ${a('intake')}`);
    if(a('uop')) statusBits.push(`urine output ${a('uop')}`);
    if(a('appearance')) statusBits.push(a('appearance'));
    if(statusBits.length) s.push(capitalize(statusBits.join(', ')) + '.');

    if(setHas(a('assoc'))) s.push(`Associated: ${fromSet(a('assoc'))}.`);
    if(a('vax')) s.push(`Vaccinations ${a('vax')}.`);
    if(a('sickcontacts')) s.push(`Sick contacts ${a('sickcontacts')}.`);
    if(a('weight_source')) s.push(`Weight ${a('weight_source')}.`);
    if(a('context')) s.push(a('context') + '.');
  }

  return s.join(' ');
}

/** =======================
 *  UTIL
 *  ======================= */
function toggleSet(set, v){ set.has(v)?set.delete(v):set.add(v); }
function ensureSetAnswer(id){ if(!(state.answers[id] instanceof Set)) state.answers[id]=new Set(); return state.answers[id]; }
function setHas(v){ return v instanceof Set && v.size>0; }
function fromSet(s){ return [...s].join(', '); }
function capitalize(s){ return s.replace(/^\s*[a-z]/, c=>c.toUpperCase()); }
function listify(arr){
  if(arr.length<=1) return arr.join('');
  const last = arr[arr.length-1];
  return arr.slice(0,-1).join(', ') + ' and ' + last;
}
function tidy(s){
  return s.replace(/\s+/g,' ')
          .replace(/\s+([.,;:])/g,'$1')
          .replace(/\.\./g,'.')
          .trim();
}
</script>
</body>
</html>
